/**
 * ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—”í‹°í‹°
 * TypeORMì„ ì‚¬ìš©í•˜ì—¬ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ì˜ user í…Œì´ë¸”ê³¼ ë§¤í•‘ë©ë‹ˆë‹¤.
 *
 * ===== ğŸš€ ì´ˆë³´ìë¥¼ ìœ„í•œ ì—”í‹°í‹° & ì¸ë±ìŠ¤ ê°œë… ê°€ì´ë“œ =====
 *
 * **ì—”í‹°í‹°(Entity)ë€?**
 * - ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ê³¼ 1:1ë¡œ ëŒ€ì‘ë˜ëŠ” í´ë˜ìŠ¤
 * - ê° ì†ì„±(í•„ë“œ)ì€ í…Œì´ë¸”ì˜ ì»¬ëŸ¼ê³¼ ë§¤í•‘ë¨
 * - TypeORMì´ ìë™ìœ¼ë¡œ SQL ì¿¼ë¦¬ ìƒì„±
 *
 * **ì¸ë±ìŠ¤(Index)ë€?**
 * - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê²€ìƒ‰ ì†ë„ë¥¼ í–¥ìƒì‹œí‚¤ëŠ” ë°ì´í„° êµ¬ì¡°
 * - ì±…ì˜ ëª©ì°¨ì™€ ê°™ì€ ì—­í•  (í˜ì´ì§€ë¥¼ ë¹ ë¥´ê²Œ ì°¾ê¸°)
 * - ì¡°íšŒëŠ” ë¹¨ë¼ì§€ì§€ë§Œ ì €ì¥/ìˆ˜ì •/ì‚­ì œëŠ” ì•½ê°„ ëŠë ¤ì§
 *
 * **ì–¸ì œ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?**
 * âœ… ìì£¼ ê²€ìƒ‰ë˜ëŠ” ì»¬ëŸ¼ (ì´ë©”ì¼, ì‚¬ìš©ìëª… ë“±)
 * âœ… WHERE ì ˆì— ìì£¼ ì‚¬ìš©ë˜ëŠ” ì»¬ëŸ¼
 * âœ… JOIN ì¡°ê±´ì— ì‚¬ìš©ë˜ëŠ” ì»¬ëŸ¼
 * âœ… ORDER BYì— ì‚¬ìš©ë˜ëŠ” ì»¬ëŸ¼
 *
 * âŒ ê±°ì˜ ê²€ìƒ‰í•˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼
 * âŒ ìì£¼ ë³€ê²½ë˜ëŠ” ì»¬ëŸ¼
 * âŒ ë°ì´í„°ê°€ ë§¤ìš° ì ì€ í…Œì´ë¸”
 *
 * **ì¸ë±ìŠ¤ ì¢…ë¥˜:**
 * 1. **ë‹¨ì¼ ì¸ë±ìŠ¤**: í•˜ë‚˜ì˜ ì»¬ëŸ¼ì—ë§Œ ì ìš©
 * 2. **ë³µí•© ì¸ë±ìŠ¤**: ì—¬ëŸ¬ ì»¬ëŸ¼ì„ ì¡°í•©í•˜ì—¬ ì ìš©
 * 3. **ê³ ìœ  ì¸ë±ìŠ¤**: ì¤‘ë³µì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ì¸ë±ìŠ¤
 * 4. **ë¶€ë¶„ ì¸ë±ìŠ¤**: íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í–‰ë§Œ ì¸ë±ì‹±
 */

import { RefreshToken } from 'src/auth/entity/refresh-token.entity';
import { Video } from 'src/video/entity/video.entity';
import {
  Column,
  CreateDateColumn,
  Entity,
  Index,
  OneToMany,
  OneToOne,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
} from 'typeorm';
import { Role } from '../enum/user.enum';

/**
 * ğŸ—ï¸ ì—”í‹°í‹° ë ˆë²¨ ë°ì½”ë ˆì´í„° ì„¤ëª…
 *
 * @Entity() - ì´ í´ë˜ìŠ¤ê°€ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì„ì„ ì„ ì–¸
 * @Index() - í…Œì´ë¸” ë ˆë²¨ì—ì„œ ë³µí•© ì¸ë±ìŠ¤ë¥¼ ì •ì˜í•  ë•Œ ì‚¬ìš©
 */
@Entity('users') // ğŸ’¡ í…Œì´ë¸”ëª…ì„ ëª…ì‹œì ìœ¼ë¡œ ì§€ì • (ê¸°ë³¸ê°’: í´ë˜ìŠ¤ëª…ì˜ ì†Œë¬¸ì)
@Index('idx_user_email_role', ['email', 'role']) // ğŸš€ ë³µí•© ì¸ë±ìŠ¤: ì´ë©”ì¼ + ì—­í•  ì¡°í•© ê²€ìƒ‰ ìµœì í™”
@Index('idx_user_created_at', ['createdAt']) // ğŸ“… ìƒì„±ì¼ ê¸°ì¤€ ì •ë ¬/ê²€ìƒ‰ ìµœì í™”
@Index('idx_user_role_created', ['role', 'createdAt']) // ğŸ‘¥ ì—­í• ë³„ + ìµœì‹ ìˆœ ì¡°íšŒ ìµœì í™”
export class User {
  /**
   * ğŸ”‘ ê¸°ë³¸ í‚¤ (Primary Key)
   *
   * @PrimaryGeneratedColumn ë°ì½”ë ˆì´í„° ìƒì„¸ ì„¤ëª…:
   * - 'uuid': UUID v4 í˜•íƒœë¡œ ìë™ ìƒì„± (ì˜ˆ: 550e8400-e29b-41d4-a716-446655440000)
   * - 'increment': ìˆ«ì ìë™ ì¦ê°€ (1, 2, 3, ...)
   * - 'rowid': í–‰ ID ì‚¬ìš© (íŠ¹ì • DBì—ì„œë§Œ)
   *
   * ğŸ¤” UUID vs ìˆ«ì ID ë¹„êµ:
   *
   * **UUID ì¥ì :**
   * âœ… ì „ì—­ì ìœ¼ë¡œ ê³ ìœ  (ë¶„ì‚° ì‹œìŠ¤í…œì— ìœ ë¦¬)
   * âœ… ì¶”ì¸¡í•˜ê¸° ì–´ë ¤ì›€ (ë³´ì•ˆìƒ ìœ ë¦¬)
   * âœ… ì—¬ëŸ¬ ë°ì´í„°ë² ì´ìŠ¤ ë³‘í•© ì‹œ ì¶©ëŒ ì—†ìŒ
   *
   * **UUID ë‹¨ì :**
   * âŒ ì €ì¥ ê³µê°„ ë” í•„ìš” (36ë°”ì´íŠ¸ vs 4ë°”ì´íŠ¸)
   * âŒ ì¸ë±ìŠ¤ ì„±ëŠ¥ ì•½ê°„ ëŠë¦¼
   * âŒ ì‚¬ëŒì´ ì½ê¸° ì–´ë ¤ì›€
   *
   * **ì–¸ì œ UUIDë¥¼ ì‚¬ìš©í• ê¹Œ?**
   * - ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½
   * - ë³´ì•ˆì´ ì¤‘ìš”í•œ ì‹œìŠ¤í…œ
   * - ì™¸ë¶€ì— IDê°€ ë…¸ì¶œë˜ëŠ” ê²½ìš°
   */
  @PrimaryGeneratedColumn('uuid')
  id: string;

  /**
   * ğŸ“§ ì´ë©”ì¼ - ê°€ì¥ ì¤‘ìš”í•œ ê²€ìƒ‰ ì¡°ê±´
   *
   * @Column ë°ì½”ë ˆì´í„° ì˜µì…˜ë“¤:
   * - unique: true â†’ ì¤‘ë³µ ë¶ˆí—ˆ (ìë™ìœ¼ë¡œ ê³ ìœ  ì¸ë±ìŠ¤ ìƒì„±)
   * - nullable: false (ê¸°ë³¸ê°’) â†’ NULL ê°’ ë¶ˆí—ˆ
   * - length: 255 (ê¸°ë³¸ê°’) â†’ ìµœëŒ€ ë¬¸ì ê¸¸ì´
   * - type: 'varchar' (ê¸°ë³¸ê°’) â†’ ë°ì´í„° íƒ€ì…
   *
   * ğŸ’¡ ì™œ unique ì¸ë±ìŠ¤ê°€ í•„ìš”í•œê°€?
   * - ë¡œê·¸ì¸ ì‹œ ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ê²€ìƒ‰
   * - íšŒì›ê°€ì… ì‹œ ì¤‘ë³µ ì´ë©”ì¼ ì²´í¬
   * - unique ì œì•½ì¡°ê±´ì€ ìë™ìœ¼ë¡œ ì¸ë±ìŠ¤ ìƒì„±
   */
  @Column({
    unique: true,
    length: 320, // ğŸ’¡ ì´ë©”ì¼ í‘œì¤€ ìµœëŒ€ ê¸¸ì´ (64@255 = 320ì)
    comment: 'ì‚¬ìš©ì ì´ë©”ì¼ ì£¼ì†Œ (ë¡œê·¸ì¸ ID)',
  })
  @Index('idx_user_email_lower', { synchronize: false }) // ğŸ” ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ëŠ” ê²€ìƒ‰ìš© (PostgreSQL ì „ìš©)
  email: string;

  /**
   * ğŸ”’ ë¹„ë°€ë²ˆí˜¸ - í•´ì‹œí™”ëœ ê°’ ì €ì¥
   *
   * ğŸ’¡ ë¹„ë°€ë²ˆí˜¸ ë³´ì•ˆ ì›ì¹™:
   * 1. ì ˆëŒ€ í‰ë¬¸(ì›ë³¸) ì €ì¥ ê¸ˆì§€
   * 2. bcrypt ë“± ë‹¨ë°©í–¥ í•´ì‹œ í•¨ìˆ˜ ì‚¬ìš©
   * 3. Salt ê°’ í¬í•¨í•˜ì—¬ ë ˆì¸ë³´ìš° í…Œì´ë¸” ê³µê²© ë°©ì§€
   * 4. ì¶©ë¶„í•œ ë¼ìš´ë“œ ìˆ˜ ì„¤ì • (10-12 ê¶Œì¥)
   */
  @Column({
    length: 60, // ğŸ’¡ bcrypt í•´ì‹œ ê²°ê³¼ ê¸¸ì´ (60ì ê³ ì •)
    comment: 'bcryptë¡œ í•´ì‹œí™”ëœ ë¹„ë°€ë²ˆí˜¸',
    select: false, // ğŸ”’ ê¸°ë³¸ ì¡°íšŒ ì‹œ ì œì™¸ (ë³´ì•ˆìƒ ì¤‘ìš”!)
  })
  password: string;

  /**
   * ğŸ‘¥ ì‚¬ìš©ì ê¶Œí•œ - ì—´ê±°í˜•(Enum) íƒ€ì…
   *
   * @Column enum ì˜µì…˜ ì„¤ëª…:
   * - PostgreSQLì—ì„œëŠ” ì‹¤ì œ ENUM íƒ€ì… ìƒì„±
   * - MySQLì—ì„œëŠ” ENUM ì»¬ëŸ¼ íƒ€ì… ì‚¬ìš©
   * - ë‹¤ë¥¸ DBì—ì„œëŠ” CHECK ì œì•½ì¡°ê±´ìœ¼ë¡œ êµ¬í˜„
   *
   * ğŸ¯ ì¸ë±ìŠ¤ê°€ í•„ìš”í•œ ì´ìœ :
   * - ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì—­í• ë³„ ì‚¬ìš©ì ì¡°íšŒ
   * - ê¶Œí•œ ì²´í¬ ì‹œ ë¹ ë¥¸ ê²€ìƒ‰ í•„ìš”
   */
  @Column({
    type: 'enum',
    enum: Role,
    default: Role.User,
    comment: 'ì‚¬ìš©ì ê¶Œí•œ ë ˆë²¨',
  })
  @Index('idx_user_role') // ğŸš€ ì—­í• ë³„ ê²€ìƒ‰ ìµœì í™”
  role: Role = Role.User;

  /**
   * ğŸ“… ìƒì„± ì‹œê°„ - ìë™ íƒ€ì„ìŠ¤íƒ¬í”„
   *
   * @CreateDateColumn íŠ¹ì§•:
   * - INSERT ì‹œ ìë™ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ ì„¤ì •
   * - í•œ ë²ˆ ì„¤ì •ë˜ë©´ ë³€ê²½ë˜ì§€ ì•ŠìŒ
   * - timezone ì •ë³´ í¬í•¨ ê¶Œì¥
   *
   * ğŸ’¡ ì¸ë±ìŠ¤ê°€ í•„ìš”í•œ ì´ìœ :
   * - ìµœì‹  ê°€ì…ì ì¡°íšŒ (ORDER BY created_at DESC)
   * - íŠ¹ì • ê¸°ê°„ ê°€ì…ì í†µê³„
   * - í˜ì´ì§€ë„¤ì´ì…˜ì—ì„œ ì»¤ì„œ ê¸°ë°˜ ì¡°íšŒ
   */
  @CreateDateColumn({
    name: 'created_at',
    type: 'timestamptz', // ğŸ’¡ timezone í¬í•¨ íƒ€ì… (PostgreSQL)
    comment: 'ê³„ì • ìƒì„± ì‹œê°',
  })
  createdAt: Date;

  /**
   * ğŸ”„ ìˆ˜ì • ì‹œê°„ - ìë™ ì—…ë°ì´íŠ¸ íƒ€ì„ìŠ¤íƒ¬í”„
   *
   * @UpdateDateColumn íŠ¹ì§•:
   * - INSERTì™€ UPDATE ì‹œ ìë™ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ ì„¤ì •
   * - ì—”í‹°í‹°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ìë™ ê°±ì‹ 
   *
   * ğŸ’¡ í™œìš© ìš©ë„:
   * - ìµœê·¼ í™œë™í•œ ì‚¬ìš©ì ì¡°íšŒ
   * - ë°ì´í„° ë™ê¸°í™” ì‹œ ë³€ê²½ ê°ì§€
   * - ìºì‹œ ë¬´íš¨í™” íŒë‹¨ ê¸°ì¤€
   */
  @UpdateDateColumn({
    name: 'updated_at',
    type: 'timestamptz',
    comment: 'ê³„ì • ì •ë³´ ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°',
  })
  updatedAt: Date;

  /**
   * ğŸ¬ ë¹„ë””ì˜¤ ê´€ê³„ - ì¼ëŒ€ë‹¤(1:N) ê´€ê³„
   *
   * @OneToMany ë°ì½”ë ˆì´í„° ì„¤ëª…:
   * - ì²« ë²ˆì§¸ ì¸ì: () => Video â†’ ê´€ë ¨ ì—”í‹°í‹° íƒ€ì…
   * - ë‘ ë²ˆì§¸ ì¸ì: (video) => video.user â†’ ì—­ë°©í–¥ ê´€ê³„ ì§€ì •
   *
   * ğŸ’¡ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ì›ì¹™:
   * - í•œ ì‚¬ìš©ìëŠ” ì—¬ëŸ¬ ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œ ê°€ëŠ¥
   * - ê° ë¹„ë””ì˜¤ëŠ” í•˜ë‚˜ì˜ ì‚¬ìš©ìì—ê²Œë§Œ ì†í•¨
   * - Video í…Œì´ë¸”ì— user_id ì™¸ë˜í‚¤ ì¡´ì¬
   *
   * ğŸš€ ì„±ëŠ¥ ìµœì í™” íŒ:
   * - videos ì¡°íšŒ ì‹œ í•„ìš”í•  ë•Œë§Œ ë¡œë“œ (ì§€ì—° ë¡œë”©)
   * - ëŒ€ëŸ‰ ë°ì´í„°ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©
   * - N+1 ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•œ JOIN ì¿¼ë¦¬ ì‚¬ìš©
   */
  @OneToMany(() => Video, (video) => video.user, {
    cascade: ['soft-remove'], // ğŸ’¡ ì‚¬ìš©ì ì‚­ì œ ì‹œ ë¹„ë””ì˜¤ëŠ” ì†Œí”„íŠ¸ ì‚­ì œ
    lazy: true, // ğŸš€ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
  })
  videos: Video[];

  /**
   * ğŸ”„ ë¦¬í”„ë ˆì‹œ í† í° - ì¼ëŒ€ì¼(1:1) ê´€ê³„
   *
   * @OneToOne ë°ì½”ë ˆì´í„° ì„¤ëª…:
   * - í•œ ì‚¬ìš©ìëŠ” í•˜ë‚˜ì˜ í™œì„± ë¦¬í”„ë ˆì‹œ í† í°ë§Œ ë³´ìœ 
   * - ë¡œê·¸ì¸ ì‹œ ê¸°ì¡´ í† í° êµì²´ ë˜ëŠ” ìƒˆë¡œ ìƒì„±
   *
   * ğŸ’¡ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­:
   * - í† í° íƒˆì·¨ ë°©ì§€ë¥¼ ìœ„í•œ ì§§ì€ ìˆ˜ëª…
   * - ë¡œê·¸ì•„ì›ƒ ì‹œ í† í° ì¦‰ì‹œ ë¬´íš¨í™”
   * - ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ ê°ì§€ ì‹œ ëª¨ë“  í† í° ë¬´íš¨í™”
   */
  @OneToOne(() => RefreshToken, (refreshToken) => refreshToken.user, {
    cascade: ['remove'], // ğŸ’¡ ì‚¬ìš©ì ì‚­ì œ ì‹œ í† í°ë„ í•¨ê»˜ ì‚­ì œ
    nullable: true, // ğŸ’¡ í† í°ì´ ì—†ëŠ” ìƒíƒœë„ í—ˆìš©
  })
  refreshToken: RefreshToken;

  // ===== ğŸ› ï¸ ê°€ìƒ í•„ë“œì™€ ë©”ì„œë“œë“¤ =====

  /**
   * ğŸ“Š ë¹„ë””ì˜¤ ê°œìˆ˜ - ê³„ì‚°ëœ í•„ë“œ
   * ì‹¤ì œ DB ì»¬ëŸ¼ì´ ì•„ë‹Œ ëŸ°íƒ€ì„ì—ì„œ ê³„ì‚°ë˜ëŠ” ê°’
   */
  videoCount?: number;

  /**
   * ğŸ• ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ - ì¶”ê°€ í•„ë“œ ì˜ˆì‹œ
   * ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œ í•„ìš” ì‹œ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” í•„ë“œ
   */
  // @Column({
  //   type: 'timestamptz',
  //   nullable: true,
  //   comment: 'ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„'
  // })
  // @Index('idx_user_last_login') // íœ´ë©´ ê³„ì • ì¡°íšŒìš©
  // lastLoginAt?: Date;

  /**
   * âœ… ê³„ì • í™œì„±í™” ìƒíƒœ - ì¶”ê°€ í•„ë“œ ì˜ˆì‹œ
   */
  // @Column({
  //   type: 'boolean',
  //   default: true,
  //   comment: 'ê³„ì • í™œì„±í™” ìƒíƒœ'
  // })
  // @Index('idx_user_active') // í™œì„± ì‚¬ìš©ìë§Œ ì¡°íšŒìš©
  // isActive: boolean = true;

  // ===== ğŸ”§ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë©”ì„œë“œë“¤ =====

  /**
   * ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ë©”ì„œë“œ
   * ì—”í‹°í‹° ë‚´ë¶€ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í¬í•¨í•  ìˆ˜ ìˆìŒ
   */
  // async validatePassword(plainPassword: string): Promise<boolean> {
  //   const bcrypt = await import('bcrypt');
  //   return bcrypt.compare(plainPassword, this.password);
  // }

  /**
   * ì‚¬ìš©ì ì •ë³´ ë§ˆìŠ¤í‚¹ ë©”ì„œë“œ
   * ë¯¼ê°í•œ ì •ë³´ë¥¼ ìˆ¨ê¸°ê³  ì•ˆì „í•œ ì •ë³´ë§Œ ë°˜í™˜
   */
  // toSafeObject() {
  //   const { password, ...safeUser } = this;
  //   return safeUser;
  // }
}
